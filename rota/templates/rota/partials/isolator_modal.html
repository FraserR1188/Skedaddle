<div class="modal" id="modal-isolator-{{ iso.id }}">
  <div class="modal-backdrop" data-close-modal="modal-isolator-{{ iso.id }}"></div>

  <div class="modal-content">

    <div class="modal-header">
      <h2>Edit Assignments – {{ iso.name }} ({{ date }})</h2>
      <button
        type="button"
        class="modal-close"
        data-close-modal="modal-isolator-{{ iso.id }}">
        &times;
      </button>
    </div>

    {# -------- CURRENT ASSIGNMENTS (READ-ONLY SUMMARY) -------- #}
    {% if iso.operator_assignments %}
      <div class="muted" style="margin-bottom: 1rem;">
        <strong>Current operators:</strong>
        <ul>
          {% for a in iso.operator_assignments %}
            <li>{{ a.staff.full_name }} – {{ a.shift.name }}</li>
          {% endfor %}
        </ul>
      </div>
    {% else %}
      <div class="muted" style="margin-bottom: 1rem;">
        <strong>No operators assigned yet.</strong>
      </div>
    {% endif %}

    <form method="post" action="{% url 'daily_rota' date.year date.month date.day %}">
      {% csrf_token %}
      <input type="hidden" name="isolator_id" value="{{ iso.id }}">

      {# ================= OPERATORS (UP TO 6) ================= #}
      <h3>Assign Operators (Max 6)</h3>
      <p class="muted">Choose a staff member and their shift time.</p>

      <div class="operator-grid">
        {% for slot in iso.operator_slots %}
          <div class="operator-row">
            <label class="operator-label">Operator {{ forloop.counter }}</label>

            {# STAFF SELECT #}
            <select name="op{{ forloop.counter }}_staff">
              <option value="">-- None --</option>
              {% for staff in staff_list %}
                {% if staff.role == "OPERATIVE" or staff.role == "SUPERVISOR" %}
                  <option value="{{ staff.id }}"
                    {% if slot and slot.staff.id == staff.id %}selected{% endif %}>
                    {{ staff.full_name }}
                  </option>
                {% endif %}
              {% endfor %}
            </select>

            {# SHIFT SELECT #}
            <select name="op{{ forloop.counter }}_shift">
              <option value="">-- Shift --</option>
              {% for shift in shift_templates %}
                <option value="{{ shift.id }}"
                  {% if slot and slot.shift.id == shift.id %}selected{% endif %}>
                  {{ shift.name }} ({{ shift.start_time }}–{{ shift.end_time }})
                </option>
              {% endfor %}
            </select>
          </div>
        {% endfor %}
      </div>

      <hr>

      {# ================= ROOM SUPERVISORS ================= #}
      <h3>Room Supervisors</h3>
      <p class="muted">
        Select up to 4 Production Supervisors for {{ room.name }}.<br>
        <span class="muted small">(Hold Ctrl/Cmd to select multiple.)</span>
      </p>

      <select name="room_supervisors" multiple size="5">
        {% for staff in supervisors %}
          <option value="{{ staff.id }}"
            {% if room.room_supervisor_ids and staff.id in room.room_supervisor_ids %}
              selected
            {% endif %}>
            {{ staff.full_name }}
          </option>
        {% endfor %}
      </select>

      <div class="modal-actions">
        <button type="submit" class="btn-pill">Save</button>
        <button
          type="button"
          class="btn-pill"
          data-close-modal="modal-isolator-{{ iso.id }}">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>
