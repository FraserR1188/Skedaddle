<div class="modal" id="modal-isolator-{{ iso.id }}">
  <div class="modal-backdrop" data-close-modal="modal-isolator-{{ iso.id }}"></div>

  <div class="modal-content">

    <div class="modal-header">
      <h2>Edit assignments – {{ iso.name }} ({{ date }})</h2>
      <button type="button"
              class="modal-close"
              data-close-modal="modal-isolator-{{ iso.id }}">
        &times;
      </button>
    </div>

    {# ----- CURRENT DUTIES SUMMARY ----- #}
    {% if iso.batch_assignments %}
      <div class="muted" style="margin-bottom: 1rem;">
        <strong>Current duties:</strong>
        <ul>
          {% for a in iso.batch_assignments %}
            <li>Batch {{ a.batch_number }} – {{ a.staff.full_name }}</li>
          {% endfor %}
        </ul>
      </div>
    {% else %}
      <div class="muted" style="margin-bottom: 1rem;">
        <strong>No duties assigned yet.</strong>
      </div>
    {% endif %}

    <form method="post" action="{% url 'daily_rota' date.year date.month date.day %}">
      {% csrf_token %}
      <input type="hidden" name="isolator_id" value="{{ iso.id }}">

      {# ================= BATCHES ================= #}
      <h3>Batches</h3>
      <p class="muted">Select a staff member for each batch.</p>

      <div class="batch-grid">
        {% for batch_num in "12345678"|make_list %}
          <div class="batch-row">
            <label>Batch {{ batch_num }}</label>

            <select name="batch_{{ batch_num }}">
              <option value="">-- None --</option>

              {# all active staff (ops + supervisors) #}
              {% for staff in staff_list %}
                <option value="{{ staff.id }}"
                  {% for a in iso.batch_assignments %}
                    {% if a.batch_number|stringformat:"s" == batch_num and a.staff_id == staff.id %}
                      selected
                    {% endif %}
                  {% endfor %}
                >
                  {{ staff.full_name }}
                </option>
              {% endfor %}
            </select>
          </div>
        {% endfor %}
      </div>

      <hr>

      {# ================= ROOM SUPERVISORS ================= #}
      <h3>Room supervisors</h3>
      <p class="muted">
        Select up to 4 Production Supervisors for {{ iso.clean_room.name }}.
      </p>

      <select name="room_supervisors" multiple size="5">
        {% with current_ids=iso.clean_room.room_supervisor_ids %}
          {% for sup in supervisors %}
            <option value="{{ sup.id }}"
              {% if current_ids and sup.id in current_ids %}
                selected
              {% endif %}
            >
              {{ sup.full_name }}
            </option>
          {% endfor %}
        {% endwith %}
      </select>

      <div class="modal-actions">
        <button type="submit" class="btn-pill">Save</button>
        <button type="button"
                class="btn-pill"
                data-close-modal="modal-isolator-{{ iso.id }}">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>
